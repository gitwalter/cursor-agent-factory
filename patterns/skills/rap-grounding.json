{
  "metadata": {
    "patternId": "rap-grounding",
    "patternName": "RAP Grounding Skill",
    "category": "sap-grounding",
    "stackAgnostic": false,
    "description": "Verify RAP Behavior Definitions including actions, determinations, validations, draft handling, and side effects",
    "composable": true,
    "version": "1.0.0"
  },
  "frontmatter": {
    "name": "rap-grounding",
    "description": "Verify RAP behavior definitions and all associated artifacts for RESTful Application Programming Model",
    "type": "skill",
    "knowledge": ["rap-catalog.json", "released-apis.json"]
  },
  "sections": {
    "title": "RAP Grounding Skill",
    "introduction": "Ensures all RAP (RESTful Application Programming Model) artifacts are verified before implementation. Covers behavior definitions, actions, determinations, validations, draft handling, side effects, authorization control, and feature control.",
    "artifactTypes": [
      {
        "type": "behavior_definition",
        "description": "RAP behavior definition (BDEF)",
        "verifications": ["existence", "implementation_type", "strict_mode", "root_entity", "authorization_master"]
      },
      {
        "type": "action",
        "description": "RAP actions (instance and static)",
        "verifications": ["name", "parameters", "return_type", "static_vs_instance", "factory", "features"]
      },
      {
        "type": "determination",
        "description": "Automatic field calculations",
        "verifications": ["name", "trigger_operations", "trigger_fields", "timing", "target_fields"]
      },
      {
        "type": "validation",
        "description": "Data validation rules",
        "verifications": ["name", "trigger_operations", "trigger_fields", "draft_vs_active"]
      },
      {
        "type": "draft_handling",
        "description": "Draft-enabled transactional behavior",
        "verifications": ["draft_table", "draft_actions", "total_etag", "lock_master"]
      },
      {
        "type": "side_effects",
        "description": "UI field refresh triggers",
        "verifications": ["trigger_fields", "target_fields", "target_entities", "target_actions"]
      },
      {
        "type": "authorization_control",
        "description": "Global and instance authorization",
        "verifications": ["auth_type", "authorization_master", "precheck"]
      },
      {
        "type": "feature_control",
        "description": "Dynamic field and action enablement",
        "verifications": ["mandatory_fields", "readonly_fields", "feature_functions"]
      }
    ],
    "implementationTypes": {
      "managed": "SAP manages persistence, locking, and authorization",
      "unmanaged": "Developer implements persistence and business logic",
      "abstract": "No persistence - used for abstract operations",
      "projection": "Business service projection of base BO"
    },
    "whenToUse": [
      "When implementing or consuming RAP business objects",
      "Before defining actions, determinations, or validations",
      "When implementing draft-enabled scenarios",
      "Before assuming behavior definition structure",
      "When designing side effects for UI responsiveness",
      "When implementing authorization for RAP BO"
    ],
    "process": [
      {
        "step": 1,
        "name": "Check Knowledge Cache",
        "description": "Look for cached BDEF definitions",
        "actions": [
          "Query knowledge/rap-catalog.json for behavior definitions",
          "Check released-apis.json for released RAP BOs"
        ]
      },
      {
        "step": 2,
        "name": "Search SAP Documentation",
        "description": "Search for RAP behavior documentation",
        "mcpTools": ["SAP_Documentation_MCP_Server-search"],
        "queryPatterns": {
          "bdef": "{BDEF_NAME} RAP behavior definition",
          "action": "{ACTION_NAME} RAP action parameters return",
          "determination": "{DET_NAME} determination trigger fields",
          "validation": "{VAL_NAME} validation trigger conditions"
        }
      },
      {
        "step": 3,
        "name": "Verify BDEF Existence",
        "description": "Confirm behavior definition exists",
        "verifications": [
          "BDEF is active and deployable",
          "Root entity CDS view exists",
          "Implementation class exists (for managed/unmanaged)"
        ]
      },
      {
        "step": 4,
        "name": "Verify Actions",
        "description": "Validate action definitions",
        "verifications": [
          "Action name exists in BDEF",
          "Parameter structure/abstract entity exists",
          "Return type structure exists",
          "Action is exposed in projection (if applicable)"
        ]
      },
      {
        "step": 5,
        "name": "Verify Determinations",
        "description": "Check determination configuration",
        "verifications": [
          "Trigger operations (create, update, delete)",
          "Trigger fields exist in entity",
          "Timing (on save, on modify)",
          "Implementation method exists"
        ]
      },
      {
        "step": 6,
        "name": "Verify Validations",
        "description": "Check validation configuration",
        "verifications": [
          "Trigger operations",
          "Trigger fields exist",
          "Validation timing (draft, active)",
          "Implementation method exists"
        ]
      },
      {
        "step": 7,
        "name": "Verify Draft Handling",
        "description": "If draft-enabled, verify draft setup",
        "verifications": [
          "Draft table exists",
          "Draft determine action defined",
          "Prepare action configured",
          "Total ETag field specified"
        ]
      },
      {
        "step": 8,
        "name": "Verify Side Effects",
        "description": "Check side effect definitions",
        "verifications": [
          "Trigger fields exist in entity",
          "Target fields/entities/actions exist",
          "Side effects are syntactically correct"
        ]
      },
      {
        "step": 9,
        "name": "Document and Escalate",
        "description": "Record results and handle failures",
        "actions": [
          "Document all verifications with sources",
          "STOP and ASK if BDEF cannot be verified",
          "Report any inconsistencies found"
        ]
      }
    ],
    "outputFormat": "### RAP Behavior Verification Results\n\n**Behavior Definition:** {BDEF_NAME}\n**Implementation Type:** {MANAGED|UNMANAGED|ABSTRACT|PROJECTION}\n**Root Entity:** {CDS_ENTITY}\n**Draft Enabled:** {YES|NO}\n**Strict Mode:** {1|2|NOT_SET}\n\n#### Actions Verified\n| Action | Parameters | Return | Static | Verified |\n|--------|------------|--------|--------|----------|\n| {ACTION} | {PARAMS} | {RETURN} | {Y/N} | {YES/NO} |\n\n#### Determinations Verified\n| Determination | Trigger Ops | Trigger Fields | Timing | Verified |\n|---------------|-------------|----------------|--------|----------|\n| {DET} | {OPS} | {FIELDS} | {TIMING} | {YES/NO} |\n\n#### Validations Verified\n| Validation | Trigger Ops | Trigger Fields | Draft | Verified |\n|------------|-------------|----------------|-------|----------|\n| {VAL} | {OPS} | {FIELDS} | {Y/N} | {YES/NO} |\n\n**Issues Found:**\n- {ISSUE_LIST}\n\n**Recommendation:** {PROCEED|STOP|ASK_USER}",
    "importantRules": [
      "NEVER assume action parameters or return types without verification",
      "Determination triggers must reference existing fields",
      "Validation triggers must reference existing fields",
      "Draft handling requires specific table and action setup",
      "Side effects must reference existing fields/entities",
      "Authorization control affects all BO operations - verify setup",
      "If BDEF unverified, STOP and ASK user"
    ],
    "fallbackProcedures": [
      {
        "condition": "BDEF not found",
        "action": "ASK USER: 'Cannot verify behavior definition {BDEF}. Is this a custom RAP BO? Please provide its definition.'"
      },
      {
        "condition": "Action not found in BDEF",
        "action": "Report that action does not exist and list available actions if known"
      },
      {
        "condition": "Trigger field not found",
        "action": "WARN: Trigger field {FIELD} not found in entity. Verify field name."
      },
      {
        "condition": "Parameter type not found",
        "action": "WARN: Action parameter type {TYPE} cannot be verified. Ensure abstract entity exists."
      }
    ]
  },
  "variables": [
    {"name": "{BDEF_NAME}", "description": "Name of behavior definition", "required": true},
    {"name": "{ACTION_NAME}", "description": "Action to verify (optional)", "required": false},
    {"name": "{DETERMINATION_NAME}", "description": "Determination to verify (optional)", "required": false},
    {"name": "{VALIDATION_NAME}", "description": "Validation to verify (optional)", "required": false}
  ]
}
