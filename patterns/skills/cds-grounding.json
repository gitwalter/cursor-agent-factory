{
  "metadata": {
    "patternId": "cds-grounding",
    "patternName": "CDS Grounding Skill",
    "category": "sap-grounding",
    "stackAgnostic": false,
    "description": "Verify CDS View Entities, associations, annotations, and access control before implementation",
    "composable": true,
    "version": "1.0.0"
  },
  "frontmatter": {
    "name": "cds-grounding",
    "description": "Verify CDS artifacts including view entities, associations, annotations, and access control",
    "type": "skill",
    "knowledge": ["cds-catalog.json", "released-apis.json"]
  },
  "sections": {
    "title": "CDS Grounding Skill",
    "introduction": "Ensures all ABAP CDS artifacts are verified against authoritative sources. Covers CDS view entities, associations, compositions, annotations, access control roles, and metadata extensions.",
    "artifactTypes": [
      {
        "type": "cds_view_entity",
        "description": "CDS view entities and views",
        "verifications": ["existence", "elements", "data_types", "parameters", "associations", "compositions"]
      },
      {
        "type": "cds_association",
        "description": "Associations between CDS entities",
        "verifications": ["target_entity", "cardinality", "join_conditions", "filter_conditions"]
      },
      {
        "type": "cds_composition",
        "description": "Parent-child compositions",
        "verifications": ["target_entity", "cardinality", "child_elements"]
      },
      {
        "type": "cds_annotation",
        "description": "CDS annotations for UI, Analytics, OData",
        "verifications": ["annotation_validity", "allowed_values", "propagation_rules", "context_applicability"]
      },
      {
        "type": "cds_access_control",
        "description": "Access control roles and conditions",
        "verifications": ["role_existence", "grant_conditions", "pfcg_mapping", "authorization_objects"]
      },
      {
        "type": "cds_metadata_extension",
        "description": "Metadata extensions for annotations",
        "verifications": ["base_entity", "extended_annotations", "layer"]
      },
      {
        "type": "cds_abstract_entity",
        "description": "Abstract entities for parameters/returns",
        "verifications": ["elements", "usage_context"]
      }
    ],
    "whenToUse": [
      "When consuming or extending any CDS view entity",
      "Before implementing OData services based on CDS",
      "When adding annotations for Fiori Elements",
      "When defining RAP behavior on CDS entities",
      "Before assuming CDS elements or annotations exist",
      "When implementing CDS access control"
    ],
    "process": [
      {
        "step": 1,
        "name": "Check Knowledge Cache",
        "description": "Look for cached CDS definitions",
        "actions": [
          "Query knowledge/cds-catalog.json for entity definitions",
          "Check released-apis.json for C1/C2 release status"
        ]
      },
      {
        "step": 2,
        "name": "Search SAP Documentation",
        "description": "Search for CDS entity documentation",
        "mcpTools": ["SAP_Documentation_MCP_Server-search", "SAP_Documentation_MCP_Server-sap_help_search"],
        "queryPatterns": {
          "entity": "{CDS_ENTITY} CDS view entity elements",
          "annotation": "{ANNOTATION} CDS annotation values",
          "access_control": "{DCL_ROLE} CDS access control PFCG"
        }
      },
      {
        "step": 3,
        "name": "Verify Entity Existence",
        "description": "Confirm the CDS entity exists",
        "verifications": [
          "DDIC activation status",
          "SQL view name (if applicable)",
          "Root entity or composition child"
        ]
      },
      {
        "step": 4,
        "name": "Verify Elements",
        "description": "Verify specific element properties",
        "verifications": [
          "Element name and alias",
          "Element data type",
          "Key element status",
          "Calculated/virtual elements",
          "Localized elements"
        ]
      },
      {
        "step": 5,
        "name": "Verify Associations",
        "description": "Check association definitions",
        "verifications": [
          "Target entity exists",
          "Cardinality ([0..1], [1..1], [0..*], [1..*])",
          "Join conditions are valid",
          "Association is exposed"
        ]
      },
      {
        "step": 6,
        "name": "Verify Annotations",
        "description": "Validate annotation usage",
        "verifications": [
          "Annotation name is valid for context",
          "Annotation value is in allowed set",
          "Propagation behavior (PROPAGATE_TO)",
          "Metadata extension compatibility"
        ]
      },
      {
        "step": 7,
        "name": "Check Release Status",
        "description": "Verify release for ABAP Cloud",
        "verifications": [
          "C1 release status",
          "VDM layer (Interface, Basic, Composite, Consumption)",
          "Deprecation status"
        ]
      },
      {
        "step": 8,
        "name": "Document and Escalate",
        "description": "Record results and handle failures",
        "actions": [
          "Document verification with sources",
          "STOP and ASK if critical elements unverified",
          "Suggest alternatives for deprecated entities"
        ]
      }
    ],
    "annotationCategories": {
      "ui": ["@UI.lineItem", "@UI.identification", "@UI.facet", "@UI.fieldGroup", "@UI.selectionField", "@UI.chart"],
      "semantics": ["@Semantics.currencyCode", "@Semantics.amount.currencyCode", "@Semantics.quantity.unitOfMeasure"],
      "odata": ["@OData.publish", "@OData.entityType.name"],
      "analytics": ["@Analytics.dataCategory", "@Analytics.query", "@Aggregation.default"],
      "consumption": ["@Consumption.valueHelpDefinition", "@Consumption.filter", "@Consumption.derivation"],
      "objectModel": ["@ObjectModel.representativeKey", "@ObjectModel.semanticKey", "@ObjectModel.text"]
    },
    "outputFormat": "### CDS Verification Results\n\n**Entity:** {CDS_ENTITY}\n**Type:** {VIEW_ENTITY|ABSTRACT_ENTITY|CUSTOM_ENTITY}\n**VDM Layer:** {INTERFACE|BASIC|COMPOSITE|CONSUMPTION}\n**Release Status:** {C1|Not Released}\n\n#### Elements Verified\n| Element | Type | Key | Verified | Source |\n|---------|------|-----|----------|--------|\n| {ELEMENT} | {TYPE} | {Y/N} | {YES/NO} | {SOURCE} |\n\n#### Associations Verified\n| Association | Target | Cardinality | Verified |\n|-------------|--------|-------------|----------|\n| {ASSOC} | {TARGET} | {CARD} | {YES/NO} |\n\n**Issues Found:**\n- {ISSUE_LIST}\n\n**Recommendation:** {PROCEED|STOP|ASK_USER}",
    "importantRules": [
      "NEVER assume CDS elements exist without verification",
      "Annotation values have strict allowed sets - verify before using",
      "Associations must point to existing, accessible entities",
      "VDM layer determines appropriate usage - respect boundaries",
      "Access control affects data visibility - verify PFCG mappings",
      "If entity unverified, STOP and ASK user"
    ],
    "fallbackProcedures": [
      {
        "condition": "CDS entity not found",
        "action": "ASK USER: 'Cannot verify {CDS_ENTITY}. Is this a custom entity? Please provide its definition.'"
      },
      {
        "condition": "Annotation not valid for context",
        "action": "Report invalid annotation and suggest correct alternatives"
      },
      {
        "condition": "Association target not found",
        "action": "WARN: Association target entity cannot be verified"
      },
      {
        "condition": "Entity not released for ABAP Cloud",
        "action": "WARN: This CDS entity is not released for use in ABAP Cloud/BTP"
      }
    ]
  },
  "variables": [
    {"name": "{CDS_ENTITY}", "description": "Name of CDS view entity", "required": true},
    {"name": "{ELEMENT_NAME}", "description": "Specific element to verify (optional)", "required": false},
    {"name": "{ANNOTATION}", "description": "Annotation to validate (optional)", "required": false}
  ]
}
