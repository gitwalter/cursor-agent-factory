{
  "metadata": {
    "schemaId": "mapping-spec-schema",
    "schemaName": "Mapping Specification Schema",
    "description": "Schema for field and structure mapping specifications used by mapping-grounding skill",
    "version": "1.0.0",
    "lastUpdated": "2025-01-28"
  },
  "specificationFormat": {
    "description": "Standard format for mapping specifications",
    "requiredColumns": [
      {"name": "Source Structure", "aliases": ["From Structure", "Source", "Src Structure"]},
      {"name": "Source Field", "aliases": ["From Field", "Source Column", "Src Field"]},
      {"name": "Target Structure", "aliases": ["To Structure", "Target", "Tgt Structure"]},
      {"name": "Target Field", "aliases": ["To Field", "Target Column", "Tgt Field"]}
    ],
    "optionalColumns": [
      {"name": "Transformation", "aliases": ["Mapping Rule", "Conversion", "Logic"]},
      {"name": "Notes", "aliases": ["Comment", "Remarks", "Description"]},
      {"name": "Mandatory", "aliases": ["Required", "Reqd"]},
      {"name": "Default Value", "aliases": ["Default", "Fallback"]},
      {"name": "Data Type", "aliases": ["Type", "Format"]},
      {"name": "Length", "aliases": ["Size", "Len"]}
    ]
  },
  "transformationTypes": {
    "direct": {
      "description": "Direct 1:1 mapping without transformation",
      "syntax": "= or DIRECT",
      "example": "Source.MATNR -> Target.MATERIAL"
    },
    "conversion_exit": {
      "description": "Apply SAP conversion routine",
      "syntax": "CONV:{EXIT_NAME}",
      "example": "CONV:ALPHA - Apply alpha conversion"
    },
    "constant": {
      "description": "Set constant value",
      "syntax": "CONST:{VALUE} or '{VALUE}'",
      "example": "CONST:X or 'ACTIVE'"
    },
    "concatenation": {
      "description": "Concatenate multiple fields",
      "syntax": "CONCAT:{FIELD1}+{FIELD2}",
      "example": "CONCAT:BUKRS+BELNR+GJAHR"
    },
    "substring": {
      "description": "Extract substring",
      "syntax": "SUBSTR:{FIELD}({START},{LENGTH})",
      "example": "SUBSTR:MATNR(0,10)"
    },
    "lookup": {
      "description": "Lookup value from table",
      "syntax": "LOOKUP:{TABLE}:{KEY_FIELD}:{VALUE_FIELD}",
      "example": "LOOKUP:T001:BUKRS:BUTXT"
    },
    "conditional": {
      "description": "Conditional mapping",
      "syntax": "IF {CONDITION} THEN {VALUE1} ELSE {VALUE2}",
      "example": "IF MTART='FERT' THEN 'FG' ELSE 'RM'"
    },
    "calculation": {
      "description": "Arithmetic calculation",
      "syntax": "CALC:{EXPRESSION}",
      "example": "CALC:MENGE*NETPR"
    },
    "date_format": {
      "description": "Date format conversion",
      "syntax": "DATE:{FORMAT}",
      "example": "DATE:YYYYMMDD -> DATE:DD.MM.YYYY"
    }
  },
  "validationRules": {
    "typeCompatibility": {
      "description": "Source and target types must be compatible",
      "compatiblePairs": [
        {"source": "CHAR", "target": ["CHAR", "STRING", "SSTRING"]},
        {"source": "NUMC", "target": ["NUMC", "CHAR", "INT1", "INT2", "INT4", "INT8"]},
        {"source": "DATS", "target": ["DATS", "CHAR", "DATN"]},
        {"source": "TIMS", "target": ["TIMS", "CHAR", "TIMN"]},
        {"source": "DEC", "target": ["DEC", "CURR", "QUAN", "FLTP"]},
        {"source": "INT4", "target": ["INT4", "INT8", "DEC", "NUMC"]}
      ],
      "requiresConversion": [
        {"source": "CHAR", "target": "DEC", "note": "Requires numeric validation"},
        {"source": "DEC", "target": "CHAR", "note": "Requires formatting"},
        {"source": "DATS", "target": "CHAR", "note": "Requires date formatting"}
      ]
    },
    "lengthCompatibility": {
      "description": "Target length should accommodate source data",
      "rules": [
        "Target length >= Source length (for CHAR types)",
        "Truncation warning if Target length < Source length",
        "Overflow warning for numeric types"
      ]
    },
    "mandatoryFields": {
      "description": "Target mandatory fields must have mappings",
      "rules": [
        "All key fields must be mapped",
        "All NOT NULL fields must be mapped or have defaults"
      ]
    }
  },
  "exampleSpecification": {
    "description": "Example mapping specification",
    "mappings": [
      {
        "sourceStructure": "VBAK",
        "sourceField": "VBELN",
        "targetStructure": "ZMY_ORDER",
        "targetField": "ORDER_ID",
        "transformation": "CONV:ALPHA",
        "mandatory": true,
        "notes": "Sales document number with alpha conversion"
      },
      {
        "sourceStructure": "VBAK",
        "sourceField": "ERDAT",
        "targetStructure": "ZMY_ORDER",
        "targetField": "CREATE_DATE",
        "transformation": "DIRECT",
        "mandatory": true,
        "notes": "Creation date"
      },
      {
        "sourceStructure": "VBAK",
        "sourceField": "AUART",
        "targetStructure": "ZMY_ORDER",
        "targetField": "ORDER_TYPE",
        "transformation": "LOOKUP:TVAK:AUART:BEZEI",
        "mandatory": false,
        "notes": "Order type description lookup"
      },
      {
        "sourceStructure": null,
        "sourceField": null,
        "targetStructure": "ZMY_ORDER",
        "targetField": "CREATED_BY",
        "transformation": "CONST:SYSTEM",
        "mandatory": true,
        "notes": "Constant value for system-created records"
      }
    ]
  },
  "confluenceFormat": {
    "description": "Expected format when specification is in Confluence",
    "tableHeaders": ["Source Structure", "Source Field", "Target Structure", "Target Field", "Transformation", "Notes"],
    "parsingNotes": [
      "Extract table content from Confluence page",
      "Handle merged cells for structure names",
      "Parse transformation rules according to syntax"
    ]
  },
  "excelFormat": {
    "description": "Expected format when specification is in Excel",
    "worksheetName": "Mapping or Sheet1",
    "headerRow": 1,
    "dataStartRow": 2,
    "parsingNotes": [
      "Skip empty rows",
      "Handle merged cells for structure names",
      "Trim whitespace from all values"
    ]
  }
}
