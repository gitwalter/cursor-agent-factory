"""
{{PROXY_NAME}} - AutoGen User Proxy Agent

Purpose: {{PROXY_PURPOSE}}
Author: {{AUTHOR}}
Date: {{DATE}}

Axiom Alignment:
- A2 (User Primacy): Proxy ensures user control
- A4 (Non-Harm): Code execution is validated
"""

from typing import Optional, Dict, Any
from autogen import UserProxyAgent
import os
import logging

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)


class {{PROXY_CLASS_NAME}}:
    """
    {{PROXY_NAME}} - AutoGen User Proxy Agent
    
    Represents the user in multi-agent systems:
    - Can execute code
    - Provides human feedback
    - Controls conversation flow
    
    Example:
        >>> proxy = {{PROXY_CLASS_NAME}}()
        >>> proxy.initiate_chat(assistant, message="Write code to calculate factorial")
    """
    
    def __init__(
        self,
        name: str = "user_proxy",
        human_input_mode: str = "TERMINATE",  # NEVER, TERMINATE, ALWAYS
        max_consecutive_auto_reply: int = 10,
        code_execution_config: Optional[Dict[str, Any]] = None,
        system_message: Optional[str] = None
    ):
        """
        Initialize user proxy agent.
        
        Args:
            name: Agent name
            human_input_mode: When to request human input
                - NEVER: Fully autonomous
                - TERMINATE: Only for termination
                - ALWAYS: For every message
            max_consecutive_auto_reply: Max auto-replies
            code_execution_config: Code execution configuration
            system_message: Custom system message
        """
        self.name = name
        self.human_input_mode = human_input_mode
        self.max_consecutive_auto_reply = max_consecutive_auto_reply
        
        # Default code execution config
        if code_execution_config is None:
            code_execution_config = {
                "work_dir": "coding",
                "use_docker": False,  # Set True for production
                "timeout": 300
            }
        
        # System message
        system_msg = system_message or """{{SYSTEM_MESSAGE}}

You are a human admin. You can execute code and provide feedback.
When a task is complete, reply TERMINATE.
"""
        
        # Create user proxy agent
        self.agent = UserProxyAgent(
            name=name,
            human_input_mode=human_input_mode,
            max_consecutive_auto_reply=max_consecutive_auto_reply,
            code_execution_config=code_execution_config,
            system_message=system_msg
        )
        
        logger.info(f"Initialized {{PROXY_NAME}} user proxy")
    
    def initiate_chat(
        self,
        recipient: Any,
        message: str,
        clear_history: bool = False
    ) -> Any:
        """
        Initiate chat with another agent.
        
        Args:
            recipient: Recipient agent
            message: Initial message
            clear_history: Clear conversation history
        
        Returns:
            Chat result
        
        Example:
            >>> result = proxy.initiate_chat(assistant, "Write Python code")
        """
        logger.info(f"Initiating chat with message: {message[:100]}...")
        
        try:
            if clear_history:
                self.agent.reset()
                recipient.reset()
            
            result = self.agent.initiate_chat(
                recipient=recipient,
                message=message
            )
            
            logger.info("Chat initiated successfully")
            return result
            
        except Exception as e:
            logger.error(f"Error initiating chat: {e}")
            return f"Error: {str(e)}"
    
    def send(
        self,
        recipient: Any,
        message: str
    ) -> Any:
        """
        Send a message to another agent.
        
        Args:
            recipient: Recipient agent
            message: Message content
        
        Returns:
            Response
        """
        logger.info(f"Sending message: {message[:100]}...")
        
        try:
            response = self.agent.send(
                recipient=recipient,
                message=message
            )
            return response
            
        except Exception as e:
            logger.error(f"Error sending message: {e}")
            return f"Error: {str(e)}"
    
    def reset(self) -> None:
        """Reset conversation history."""
        logger.info("Resetting user proxy")
        self.agent.reset()
    
    def get_name(self) -> str:
        """Get agent name."""
        return self.name
    
    def get_human_input_mode(self) -> str:
        """Get human input mode."""
        return self.human_input_mode


# Example usage
if __name__ == "__main__":
    from autogen import AssistantAgent
    
    # Create user proxy
    proxy = {{PROXY_CLASS_NAME}}(
        human_input_mode="TERMINATE"
    )
    
    # Create assistant agent
    assistant = AssistantAgent(
        name="assistant",
        system_message="You are a helpful assistant.",
        llm_config={
            "model": "{{MODEL_NAME}}",
            "api_key": os.getenv("OPENAI_API_KEY")
        }
    )
    
    # Initiate chat
    result = proxy.initiate_chat(
        assistant,
        message="{{EXAMPLE_MESSAGE}}"
    )
    
    print(f"Chat Result: {result}")
