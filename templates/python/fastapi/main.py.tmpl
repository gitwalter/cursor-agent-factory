"""
FastAPI Application Entry Point

Purpose: Initialize and configure FastAPI application
Author: {{AUTHOR}}
Created: {{DATE}}

Axiom Alignment:
- A1 (Verifiability): Application configuration is explicit and documented
- A3 (Transparency): Clear startup and shutdown logging
- A4 (Non-Harm): Proper error handling and graceful shutdown
"""

from contextlib import asynccontextmanager
from fastapi import FastAPI, Request
from fastapi.middleware.cors import CORSMiddleware
from fastapi.middleware.trustedhost import TrustedHostMiddleware
from fastapi.responses import JSONResponse
import logging
import uvicorn

from .config.settings import settings
from .middleware.error_handler import global_exception_handler, {{ERROR_HANDLER_CLASS_NAME}}
from .domain.router import router as {{MODULE_NAME}}_router

# Configure logging
logging.basicConfig(
    level=getattr(logging, settings.log_level),
    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s"
)
logger = logging.getLogger(__name__)


@asynccontextmanager
async def lifespan(app: FastAPI):
    """
    Application lifespan context manager.
    
    Handles startup and shutdown logic for the FastAPI application.
    
    Args:
        app: FastAPI application instance
        
    Yields:
        None
    """
    # Startup
    logger.info(f"Starting {settings.app_name} v{settings.app_version}")
    logger.info(f"Environment: {settings.environment}")
    logger.info(f"Debug mode: {settings.debug}")
    
    # Initialize database connection pool, etc.
    # Example:
    # await init_database()
    # await init_redis()
    
    yield
    
    # Shutdown
    logger.info(f"Shutting down {settings.app_name}")
    # Cleanup resources
    # Example:
    # await close_database()
    # await close_redis()


def create_app() -> FastAPI:
    """
    Create and configure FastAPI application.
    
    Returns:
        Configured FastAPI application instance
    """
    app = FastAPI(
        title=settings.api_title,
        version=settings.api_version,
        description="{{APP_DESCRIPTION}}",
        docs_url="/docs" if settings.debug else None,
        redoc_url="/redoc" if settings.debug else None,
        openapi_url="/openapi.json" if settings.debug else None,
        lifespan=lifespan
    )
    
    # Register exception handlers
    app.add_exception_handler(Exception, global_exception_handler)
    
    # Add middleware
    setup_middleware(app)
    
    # Register routers
    setup_routers(app)
    
    # Health check endpoint
    @app.get("/health", tags=["Health"])
    async def health_check():
        """
        Health check endpoint.
        
        Returns:
            Health status
        """
        return {
            "status": "healthy",
            "app": settings.app_name,
            "version": settings.app_version,
            "environment": settings.environment
        }
    
    return app


def setup_middleware(app: FastAPI) -> None:
    """
    Configure application middleware.
    
    Args:
        app: FastAPI application instance
    """
    # CORS middleware
    app.add_middleware(
        CORSMiddleware,
        allow_origins=settings.cors_origins,
        allow_credentials=settings.cors_allow_credentials,
        allow_methods=settings.cors_allow_methods,
        allow_headers=settings.cors_allow_headers,
    )
    
    # Trusted host middleware (for production)
    if settings.is_production:
        app.add_middleware(
            TrustedHostMiddleware,
            allowed_hosts=["*"]  # Configure appropriately for your domain
        )
    
    logger.info("Middleware configured")


def setup_routers(app: FastAPI) -> None:
    """
    Register application routers.
    
    Args:
        app: FastAPI application instance
    """
    # Include domain routers
    app.include_router({{MODULE_NAME}}_router)
    
    # Add more routers as needed
    # app.include_router(another_router)
    
    logger.info("Routers registered")


# Create application instance
app = create_app()


def main():
    """
    Main entry point for running the application.
    
    This function starts the Uvicorn server with the configured settings.
    """
    uvicorn.run(
        "{{MODULE_NAME}}.main:app",
        host=settings.host,
        port=settings.port,
        reload=settings.debug,
        log_level=settings.log_level.lower()
    )


if __name__ == "__main__":
    main()