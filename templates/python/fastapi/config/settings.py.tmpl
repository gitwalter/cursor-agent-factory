"""
Application Settings - Configuration management using Pydantic BaseSettings

Purpose: Centralized configuration management with environment variable support
Author: {{AUTHOR}}
Created: {{DATE}}

Axiom Alignment:
- A1 (Verifiability): All settings are typed and validated
- A3 (Transparency): Clear configuration structure and defaults
- A4 (Non-Harm): Sensitive values are properly handled
"""

from typing import Optional, List
from pydantic import BaseSettings, Field, validator
from functools import lru_cache
import os


class Settings(BaseSettings):
    """
    Application settings with environment variable support.
    
    This class uses Pydantic BaseSettings to automatically load
    configuration from environment variables. Settings can be
    overridden via .env file or environment variables.
    
    Example:
        >>> settings = Settings()
        >>> print(settings.database_url)
    """
    
    # Application
    app_name: str = Field(
        default="{{APP_NAME}}",
        description="Application name"
    )
    app_version: str = Field(
        default="1.0.0",
        description="Application version"
    )
    debug: bool = Field(
        default=False,
        description="Debug mode"
    )
    environment: str = Field(
        default="development",
        description="Environment (development, staging, production)"
    )
    
    # API
    api_prefix: str = Field(
        default="/api/v1",
        description="API URL prefix"
    )
    api_title: str = Field(
        default="{{APP_NAME}} API",
        description="API documentation title"
    )
    api_version: str = Field(
        default="1.0.0",
        description="API version"
    )
    
    # Server
    host: str = Field(
        default="0.0.0.0",
        description="Server host"
    )
    port: int = Field(
        default=8000,
        ge=1,
        le=65535,
        description="Server port"
    )
    
    # Database
    database_url: str = Field(
        ...,
        description="Database connection URL"
    )
    database_pool_size: int = Field(
        default=10,
        ge=1,
        description="Database connection pool size"
    )
    database_max_overflow: int = Field(
        default=20,
        ge=0,
        description="Database connection pool max overflow"
    )
    database_echo: bool = Field(
        default=False,
        description="Echo SQL queries (for debugging)"
    )
    
    # Security
    secret_key: str = Field(
        ...,
        min_length=32,
        description="Secret key for encryption"
    )
    algorithm: str = Field(
        default="HS256",
        description="JWT algorithm"
    )
    access_token_expire_minutes: int = Field(
        default=30,
        ge=1,
        description="Access token expiration time in minutes"
    )
    
    # CORS
    cors_origins: List[str] = Field(
        default=["http://localhost:3000", "http://localhost:8000"],
        description="Allowed CORS origins"
    )
    cors_allow_credentials: bool = Field(
        default=True,
        description="Allow CORS credentials"
    )
    cors_allow_methods: List[str] = Field(
        default=["*"],
        description="Allowed CORS methods"
    )
    cors_allow_headers: List[str] = Field(
        default=["*"],
        description="Allowed CORS headers"
    )
    
    # Logging
    log_level: str = Field(
        default="INFO",
        description="Logging level"
    )
    log_format: str = Field(
        default="json",
        description="Log format (json, text)"
    )
    
    # External Services (add as needed)
    # redis_url: Optional[str] = Field(None, description="Redis connection URL")
    # redis_ttl: int = Field(default=3600, description="Redis TTL in seconds")
    
    class Config:
        """Pydantic configuration."""
        env_file = ".env"
        env_file_encoding = "utf-8"
        case_sensitive = False
        
        # Allow nested settings
        env_nested_delimiter = "__"
    
    @validator("environment")
    def validate_environment(cls, v):
        """
        Validate environment value.
        
        Args:
            v: Environment value
            
        Returns:
            Validated environment
            
        Raises:
            ValueError: If environment is invalid
        """
        allowed = ["development", "staging", "production"]
        if v not in allowed:
            raise ValueError(f"Environment must be one of {allowed}")
        return v
    
    @validator("log_level")
    def validate_log_level(cls, v):
        """
        Validate log level value.
        
        Args:
            v: Log level value
            
        Returns:
            Validated log level
            
        Raises:
            ValueError: If log level is invalid
        """
        allowed = ["DEBUG", "INFO", "WARNING", "ERROR", "CRITICAL"]
        if v.upper() not in allowed:
            raise ValueError(f"Log level must be one of {allowed}")
        return v.upper()
    
    @property
    def database_url_sync(self) -> str:
        """
        Get synchronous database URL (for Alembic migrations).
        
        Returns:
            Synchronous database URL
        """
        # Convert async URL to sync if needed
        # Example: postgresql+asyncpg:// -> postgresql://
        return self.database_url.replace("+asyncpg", "").replace("+aiomysql", "")
    
    @property
    def is_production(self) -> bool:
        """
        Check if running in production environment.
        
        Returns:
            True if production, False otherwise
        """
        return self.environment == "production"
    
    @property
    def is_development(self) -> bool:
        """
        Check if running in development environment.
        
        Returns:
            True if development, False otherwise
        """
        return self.environment == "development"


@lru_cache()
def get_settings() -> Settings:
    """
    Get cached settings instance.
    
    This function uses LRU cache to ensure settings are loaded
    only once and reused across the application.
    
    Returns:
        Settings instance
    """
    return Settings()


# Export settings instance
settings = get_settings()