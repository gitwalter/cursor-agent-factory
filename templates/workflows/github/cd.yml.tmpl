name: CD

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        type: choice
        options:
          - staging
          - production
      skip-tests:
        description: 'Skip tests before deployment'
        required: false
        type: boolean
        default: false

env:
  PROJECT_NAME: {{PROJECT_NAME}}
  REGISTRY: {{REGISTRY}}
  IMAGE_NAME: {{PROJECT_NAME}}

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-${{ github.event.inputs.environment || 'production' }}
  cancel-in-progress: false

jobs:
  determine-environment:
    name: Determine Environment
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
      is-production: ${{ steps.set-env.outputs.is-production }}
      image-tag: ${{ steps.set-env.outputs.image-tag }}
    steps:
      - name: Set environment
        id: set-env
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
            echo "is-production=${{ github.event.inputs.environment == 'production' }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            echo "environment=production" >> $GITHUB_OUTPUT
            echo "is-production=true" >> $GITHUB_OUTPUT
          else
            echo "environment=staging" >> $GITHUB_OUTPUT
            echo "is-production=false" >> $GITHUB_OUTPUT
          fi
          
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            echo "image-tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref }}" == "refs/heads/main" ]; then
            echo "image-tag=latest" >> $GITHUB_OUTPUT
          else
            echo "image-tag=${GITHUB_SHA::8}" >> $GITHUB_OUTPUT
          fi

  run-tests:
    name: Run Tests Before Deployment
    if: github.event.inputs.skip-tests != 'true'
    needs: determine-environment
    uses: ./.github/workflows/reusable/python-test.yml
    with:
      python-version: '{{DEFAULT_PYTHON_VERSION}}'
      test-command: 'pytest'
      coverage-threshold: '80'

  build-and-push:
    name: Build and Push Docker Image
    needs: [determine-environment, run-tests]
    if: always() && (needs.run-tests.result == 'success' || needs.run-tests.result == 'skipped')
    uses: ./.github/workflows/reusable/docker-build.yml
    with:
      image-name: ${{ env.IMAGE_NAME }}
      registry: ${{ env.REGISTRY }}
      platforms: 'linux/amd64,linux/arm64'
      push: true
      tags: ${{ needs.determine-environment.outputs.image-tag }}
      cache-to: 'registry'
    secrets:
      REGISTRY_USERNAME: ${{ secrets.REGISTRY_USERNAME }}
      REGISTRY_PASSWORD: ${{ secrets.REGISTRY_PASSWORD }}

  deploy-staging:
    name: Deploy to Staging
    needs: [determine-environment, build-and-push]
    if: needs.determine-environment.outputs.environment == 'staging'
    environment:
      name: staging
      url: https://staging.{{PROJECT_NAME}}.com
    runs-on: ubuntu-latest
    permissions:
      contents: read
      deployments: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to staging
        run: |
          echo "Deploying to staging environment..."
          echo "Image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.determine-environment.outputs.image-tag }}"
          # Add your deployment commands here
          # Example: kubectl set image deployment/app app=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.determine-environment.outputs.image-tag }}

      - name: Run smoke tests
        run: |
          echo "Running smoke tests..."
          # Add smoke test commands here

      - name: Create deployment status
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: context.payload.deployment?.id || 0,
              state: 'success',
              environment: 'staging'
            });

  deploy-production:
    name: Deploy to Production
    needs: [determine-environment, build-and-push]
    if: needs.determine-environment.outputs.is-production == 'true'
    environment:
      name: production
      url: https://{{PROJECT_NAME}}.com
    runs-on: ubuntu-latest
    permissions:
      contents: read
      deployments: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to production
        run: |
          echo "Deploying to production environment..."
          echo "Image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.determine-environment.outputs.image-tag }}"
          # Add your deployment commands here
          # Example: kubectl set image deployment/app app=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.determine-environment.outputs.image-tag }}

      - name: Run smoke tests
        run: |
          echo "Running smoke tests..."
          # Add smoke test commands here

      - name: Create deployment status
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: context.payload.deployment?.id || 0,
              state: 'success',
              environment: 'production'
            });

      - name: Create GitHub release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Release ${{ github.ref }}
          body: |
            Automated release for ${{ github.ref }}
            
            **Changes:**
            - See commit history for details
            
            **Docker Image:**
            `${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.determine-environment.outputs.image-tag }}`
          draft: false
          prerelease: false

  notify:
    name: Notify Deployment Status
    needs: [deploy-staging, deploy-production]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Send notification
        run: |
          if [ "${{ needs.deploy-staging.result }}" == "success" ] || [ "${{ needs.deploy-production.result }}" == "success" ]; then
            echo "Deployment successful"
            # Add notification logic here (Slack, email, etc.)
          else
            echo "Deployment failed"
            # Add failure notification logic here
          fi
