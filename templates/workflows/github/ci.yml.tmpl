name: CI

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:

env:
  PROJECT_NAME: {{PROJECT_NAME}}
  DEFAULT_PYTHON_VERSION: {{DEFAULT_PYTHON_VERSION}}
  DEFAULT_NODE_VERSION: {{DEFAULT_NODE_VERSION}}

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  python-tests:
    name: Python Tests
    if: contains(github.event.head_commit.message, '[skip ci]') == false
    uses: ./.github/workflows/reusable/python-test.yml
    with:
      python-version: ${{ env.DEFAULT_PYTHON_VERSION }}
      matrix-python-versions: '{{DEFAULT_PYTHON_VERSION}},3.11,3.12'
      test-command: 'pytest'
      test-path: 'tests/'
      coverage-threshold: '80'
      upload-coverage: true
    secrets:
      COVERAGE_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  node-tests:
    name: Node.js Tests
    if: contains(github.event.head_commit.message, '[skip ci]') == false
    uses: ./.github/workflows/reusable/node-test.yml
    with:
      node-version: ${{ env.DEFAULT_NODE_VERSION }}
      matrix-node-versions: '18,20,22'
      package-manager: 'npm'
      run-lint: true
      run-build: true

  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Python linter
        continue-on-error: true
        uses: ./.github/workflows/composite/setup-python.yml
        with:
          python-version: ${{ env.DEFAULT_PYTHON_VERSION }}
        run: |
          pip install ruff black isort
          ruff check .
          black --check .
          isort --check-only .

      - name: Run Node.js linter
        continue-on-error: true
        uses: ./.github/workflows/composite/setup-node.yml
        with:
          node-version: ${{ env.DEFAULT_NODE_VERSION }}
        run: |
          npm run lint || true

      - name: Comment PR with lint results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const lintResults = {
              python: process.env.PYTHON_LINT_STATUS || 'unknown',
              node: process.env.NODE_LINT_STATUS || 'unknown'
            };
            console.log('Lint results:', lintResults);

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Run Python dependency check
        continue-on-error: true
        uses: ./.github/workflows/composite/setup-python.yml
        with:
          python-version: ${{ env.DEFAULT_PYTHON_VERSION }}
        run: |
          pip install safety
          safety check --json || true

      - name: Run npm audit
        continue-on-error: true
        uses: ./.github/workflows/composite/setup-node.yml
        with:
          node-version: ${{ env.DEFAULT_NODE_VERSION }}
        run: |
          npm audit --audit-level=moderate || true

  build-status:
    name: Build Status
    needs: [python-tests, node-tests, lint, security-scan]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check job status
        run: |
          if [ "${{ needs.python-tests.result }}" != "success" ] || \
             [ "${{ needs.node-tests.result }}" != "success" ] || \
             [ "${{ needs.lint.result }}" != "success" ] || \
             [ "${{ needs.security-scan.result }}" != "success" ]; then
            echo "One or more jobs failed"
            exit 1
          fi
          echo "All jobs passed successfully"
