"""
Pytest-BDD configuration and fixtures for {{PROJECT_NAME}}.

Generated by Cursor Agent Factory - BDD Skill
Framework: pytest-bdd (Python)

This file provides shared fixtures and configuration for BDD tests.
"""

import pytest
from pytest_bdd import scenarios, given, when, then, parsers

# ============================================================================
# Load all feature files from the features directory
# ============================================================================

# Uncomment to auto-load all scenarios from a directory
# scenarios('../features/')


# ============================================================================
# Shared Fixtures
# ============================================================================

@pytest.fixture
def context():
    """
    Shared context object for passing data between steps.
    
    Returns:
        dict: Empty context dictionary that steps can populate
    """
    return {}


@pytest.fixture
def app_client():
    """
    Application client fixture for API testing.
    
    Returns:
        TestClient: Configured test client for the application
    """
    # TODO: Import and configure your test client
    # from your_app import create_app
    # app = create_app(testing=True)
    # return app.test_client()
    pass


@pytest.fixture
def database():
    """
    Database fixture with automatic rollback after each test.
    
    Yields:
        Database session that will be rolled back after the test
    """
    # TODO: Configure your database session
    # from your_app.database import SessionLocal
    # db = SessionLocal()
    # yield db
    # db.rollback()
    # db.close()
    pass


@pytest.fixture
def authenticated_user(context):
    """
    Fixture providing an authenticated user for tests requiring login.
    
    Args:
        context: Shared context dictionary
        
    Returns:
        User object with authentication credentials
    """
    # TODO: Create and return authenticated user
    # user = create_test_user()
    # context['user'] = user
    # return user
    pass


# ============================================================================
# Shared Step Definitions (using pytest-bdd syntax)
# ============================================================================

@given('the system is ready')
def system_ready(context):
    """
    Common precondition ensuring the system is in a ready state.
    
    Args:
        context: Shared context dictionary
    """
    context['system_ready'] = True


@given(parsers.parse('I am logged in as a {role}'))
def logged_in_as_role(context, role: str):
    """
    Log in as a user with the specified role.
    
    Args:
        context: Shared context dictionary
        role: User role (e.g., 'admin', 'user', 'guest')
    """
    context['user_role'] = role
    # TODO: Implement actual login logic


@when(parsers.parse('I wait for {seconds:d} seconds'))
def wait_seconds(seconds: int):
    """
    Wait for specified duration (use sparingly).
    
    Args:
        seconds: Number of seconds to wait
    """
    import time
    time.sleep(seconds)


@then('the operation should succeed')
def operation_succeeds(context):
    """
    Verify that the operation completed successfully.
    
    Args:
        context: Shared context dictionary
    """
    assert context.get('success', True), "Operation did not succeed"


@then(parsers.parse('I should see the message "{message}"'))
def should_see_message(context, message: str):
    """
    Verify that a specific message is displayed.
    
    Args:
        context: Shared context dictionary
        message: Expected message text
    """
    actual_message = context.get('message', '')
    assert message in actual_message, f"Expected '{message}' but got '{actual_message}'"


@then('an error should be raised')
def error_raised(context):
    """
    Verify that an error was raised during the operation.
    
    Args:
        context: Shared context dictionary
    """
    assert context.get('error') is not None, "Expected an error but none was raised"


# ============================================================================
# Pytest Hooks for BDD
# ============================================================================

def pytest_bdd_before_scenario(request, feature, scenario):
    """
    Hook called before each scenario execution.
    
    Args:
        request: Pytest request fixture
        feature: Feature object
        scenario: Scenario object
    """
    print(f"\n>>> Starting scenario: {scenario.name}")


def pytest_bdd_after_scenario(request, feature, scenario):
    """
    Hook called after each scenario execution.
    
    Args:
        request: Pytest request fixture
        feature: Feature object
        scenario: Scenario object
    """
    print(f"<<< Finished scenario: {scenario.name}")


def pytest_bdd_step_error(request, feature, scenario, step, step_func, step_func_args, exception):
    """
    Hook called when a step fails.
    
    Args:
        request: Pytest request fixture
        feature: Feature object
        scenario: Scenario object
        step: Step object that failed
        step_func: Step function that raised the exception
        step_func_args: Arguments passed to the step function
        exception: The exception that was raised
    """
    print(f"!!! Step failed: {step.name}")
    print(f"    Error: {exception}")
