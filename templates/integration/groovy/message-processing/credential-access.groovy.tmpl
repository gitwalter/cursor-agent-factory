/**
 * ${SCRIPT_NAME} - Secure Credential Access
 * 
 * Purpose: ${SCRIPT_PURPOSE}
 * Author: ${AUTHOR}
 * Created: ${DATE}
 * 
 * Input:  ${INPUT_FORMAT}
 * Output: ${OUTPUT_FORMAT}
 * 
 * Security Notes:
 *   - NEVER hardcode credentials in scripts
 *   - Use Secure Parameters for sensitive data
 *   - Use User Credentials artifact for authentication
 *   - Credentials are accessed via message properties set by CPI
 * 
 * Configuration:
 *   - Secure Parameter Name: ${SECURE_PARAMETER_NAME}
 *   - User Credentials Alias: ${CREDENTIALS_ALIAS}
 * 
 * Properties Used:
 *   - ${CREDENTIAL_PROPERTY}: Credential value from Secure Parameter
 *   - ${USERNAME_PROPERTY}: Username from User Credentials
 *   - ${PASSWORD_PROPERTY}: Password from User Credentials
 */
import com.sap.gateway.ip.core.customdev.util.Message

def Message processData(Message message) {
    def messageLog = messageLogFactory.getMessageLog(message)
    
    try {
        // =====================================================
        // Access Secure Parameter
        // Secure Parameters are set via CPI artifact configuration
        // and accessed via message properties
        // =====================================================
        
        // Option 1: Access Secure Parameter directly
        // The property name matches the Secure Parameter name configured in iFlow
        def secureParam = message.getProperty('${SECURE_PARAMETER_NAME}')
        
        if (!secureParam) {
            throw new Exception("Secure Parameter '${SECURE_PARAMETER_NAME}' not found. Ensure it's configured in iFlow.")
        }
        
        // Option 2: Access User Credentials
        // User Credentials are set by the adapter (e.g., HTTP adapter)
        // and accessed via standard properties
        /*
        def username = message.getProperty('${USERNAME_PROPERTY}') // e.g., 'SAP_UserCredential_Username'
        def password = message.getProperty('${PASSWORD_PROPERTY}') // e.g., 'SAP_UserCredential_Password'
        
        if (!username || !password) {
            throw new Exception("User Credentials not found. Ensure User Credentials artifact is configured in adapter.")
        }
        */
        
        // =====================================================
        // TODO: Use credentials for your operation
        // =====================================================
        
        // Example: Use credentials for HTTP call
        /*
        def httpUrl = secureParam // URL from Secure Parameter
        def httpHeaders = [
            'Authorization': "Basic ${"${username}:${password}".bytes.encodeBase64().toString()}",
            'Content-Type': 'application/json'
        ]
        
        // Make HTTP call using credentials
        def response = makeHttpCall(httpUrl, httpHeaders, message.getBody(String))
        */
        
        // Example: Use credentials for database connection
        /*
        def dbUrl = secureParam // Database URL from Secure Parameter
        def dbUser = username
        def dbPassword = password
        
        // Connect to database using credentials
        def result = queryDatabase(dbUrl, dbUser, dbPassword, message.getBody(String))
        */
        
        // Example: Use API key from Secure Parameter
        /*
        def apiKey = secureParam
        def apiHeaders = [
            'X-API-Key': apiKey,
            'Content-Type': 'application/json'
        ]
        
        def response = makeApiCall(apiHeaders, message.getBody(String))
        */
        
        // Your logic here using credentials
        def body = message.getBody(String)
        def result = processWithCredentials(body, secureParam, messageLog)
        
        // =====================================================
        
        // IMPORTANT: Never log credentials in attachments
        // Only log that credentials were accessed successfully
        messageLog.addAttachmentAsString('CredentialAccess', 
            "Credentials accessed successfully for operation", 
            'text/plain')
        
        message.setBody(result)
        
    } catch (Exception e) {
        // Log error without exposing credentials
        messageLog.addAttachmentAsString('CredentialError', 
            "Error accessing credentials: ${e.message}", 
            'text/plain')
        
        message.setProperty('ErrorMessage', e.message)
        message.setProperty('ErrorScript', '${SCRIPT_NAME}')
        message.setProperty('ErrorTimestamp', new Date().format("yyyy-MM-dd'T'HH:mm:ss.SSSZ"))
        message.setProperty('SAP_ErrorModelStepID', '${SCRIPT_NAME}')
        message.setProperty('SAP_ErrorText', "Credential access failed: ${e.message}")
        
        throw e
    }
    
    return message
}

/**
 * Process business logic using credentials
 * Replace with your actual implementation
 */
def processWithCredentials(String input, String credential, messageLog) {
    // TODO: Implement your logic using the credential
    // Example:
    /*
    // Use credential for external API call
    def url = credential
    def response = makeHttpCall(url, input)
    return response
    */
    
    return input
}

/**
 * Helper: Make HTTP call with credentials
 * Example implementation - customize as needed
 */
def makeHttpCall(String url, Map headers, String body) {
    // TODO: Implement HTTP call using Groovy HTTPBuilder or similar
    // Example using HttpURLConnection:
    /*
    import java.net.HttpURLConnection
    import java.net.URL
    
    def connection = new URL(url).openConnection() as HttpURLConnection
    connection.setRequestMethod('POST')
    headers.each { key, value ->
        connection.setRequestProperty(key, value)
    }
    connection.setDoOutput(true)
    connection.getOutputStream().write(body.getBytes('UTF-8'))
    
    def responseCode = connection.getResponseCode()
    def responseBody = connection.getInputStream().text
    
    if (responseCode >= 400) {
        throw new Exception("HTTP error ${responseCode}: ${responseBody}")
    }
    
    return responseBody
    */
    
    return body
}

/**
 * Security Best Practices:
 * 
 * 1. NEVER log credentials:
 *    ❌ messageLog.addAttachmentAsString('Cred', password, 'text/plain')
 *    ✅ messageLog.addAttachmentAsString('Cred', 'Credentials accessed', 'text/plain')
 * 
 * 2. NEVER hardcode credentials:
 *    ❌ def password = 'mypassword123'
 *    ✅ def password = message.getProperty('SecurePassword')
 * 
 * 3. NEVER store credentials in message properties unnecessarily:
 *    ❌ message.setProperty('Password', password)
 *    ✅ Use credentials only when needed, don't persist them
 * 
 * 4. Use Secure Parameters for:
 *    - API keys
 *    - Database connection strings
 *    - URLs
 *    - Configuration values
 * 
 * 5. Use User Credentials for:
 *    - Username/password authentication
 *    - OAuth client credentials
 *    - Certificate-based authentication
 */
